<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ディオクリニック公式サイトへ移動中...</title>
    <meta name="description" content="ディオクリニックの公式サイトへリダイレクトしています。">
    <meta name="referrer" content="unsafe-url">
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <meta http-equiv="Content-Security-Policy" content="referrer unsafe-url">
    <!-- Analytics -->
    <script src="/analytics.js"></script>
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9f2f9 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            color: #333;
        }
        .redirect-container {
            text-align: center;
            padding: 40px;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        .clinic-logo {
            width: 200px;
            height: auto;
            margin-bottom: 20px;
        }
        .redirect-message {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4bc0c0;
        }
        .redirect-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .loading-animation {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4bc0c0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .manual-link {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: #4bc0c0;
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: background 0.3s ease;
        }
        .manual-link:hover {
            background: #3da9a9;
        }
        .countdown {
            font-size: 16px;
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="redirect-container">
        <img src="/images/clinics/dio/dio-logo.webp" alt="ディオクリニック" class="clinic-logo">
        <div class="loading-animation"></div>
        <h1 class="redirect-message">ディオクリニック公式サイトへ移動中...</h1>
        <p class="redirect-description">
            まもなく自動的にディオクリニックの公式サイトへリダイレクトします。<br>
            移動しない場合は下のボタンをクリックしてください。
        </p>
        <div class="countdown" id="countdown">2秒後に移動します...</div>
        <a href="#" id="manualLink" class="manual-link">ディオクリニック公式サイトへ</a>
    </div>

    <!-- Centralized Clinic URLs -->
    <script src="/config/clinic-urls.js?v=2.4.0&t=20250807_1700"></script>
    
    <script>
        // URLパラメータを取得
        const urlParams = new URLSearchParams(window.location.search);
        
        // パラメータログ出力（デバッグ用）
        console.log('========== ディオクリニック リダイレクトページ ==========');
        console.log('📍 現在のURL:', window.location.href);
        console.log('📋 受け取ったパラメータ:');
        for (const [key, value] of urlParams) {
            console.log(`  ${key}: ${value}`);
        }
        console.log('=============================================');
        
        // ベースURL（中央管理から取得）
        const baseUrl = window.CLINIC_URLS && window.CLINIC_URLS.dio ? 
            window.CLINIC_URLS.dio.baseUrl : 
            'https://sss.ac01.l-ad.net/cl/p1a64143O61e70f7/?bid=a6640dkh37648h88&param2=UTM_CREATIVE_PLACEHOLDER&param3=GCLID_PLACEHOLDER';
        
        // gclidを取得
        const gclid = urlParams.get('gclid');
        console.log('🔍 GCLID検出:', gclid || 'なし');
        
        // utm_creativeを取得
        const utm_creative = urlParams.get('utm_creative');
        console.log('🔍 UTM_CREATIVE検出:', utm_creative || 'なし');
        
        // GCLID_PLACEHOLDERをgclidで置換（gclidがある場合）
        let processedBaseUrl = baseUrl;
        console.log('🔄 GCLID置換前URL:', processedBaseUrl);
        console.log('🔍 GCLID_PLACEHOLDER検出:', processedBaseUrl.includes('GCLID_PLACEHOLDER'));
        if (gclid && processedBaseUrl.includes('GCLID_PLACEHOLDER')) {
            console.log('🔄 置換実行: GCLID_PLACEHOLDER → ' + gclid);
            processedBaseUrl = processedBaseUrl.replace('GCLID_PLACEHOLDER', gclid);
            console.log('🔄 GCLID置換実行:', gclid);
            console.log('✅ 置換後URL:', processedBaseUrl);
        } else if (processedBaseUrl.includes('GCLID_PLACEHOLDER')) {
            // gclidがない場合はプレースホルダーを空文字で置換
            processedBaseUrl = processedBaseUrl.replace('GCLID_PLACEHOLDER', '');
            console.log('⚠️ GCLIDなし: プレースホルダーを空文字で置換');
        }
        
        // UTM_CREATIVE_PLACEHOLDERをutm_creativeで置換（utm_creativeがある場合）
        console.log('🔄 UTM_CREATIVE置換前URL:', processedBaseUrl);
        console.log('🔍 UTM_CREATIVE_PLACEHOLDER検出:', processedBaseUrl.includes('UTM_CREATIVE_PLACEHOLDER'));
        if (utm_creative && processedBaseUrl.includes('UTM_CREATIVE_PLACEHOLDER')) {
            console.log('🔄 置換実行: UTM_CREATIVE_PLACEHOLDER → ' + utm_creative);
            processedBaseUrl = processedBaseUrl.replace('UTM_CREATIVE_PLACEHOLDER', utm_creative);
            console.log('🔄 UTM_CREATIVE置換実行:', utm_creative);
            console.log('✅ param2置換後URL:', processedBaseUrl);
        } else if (processedBaseUrl.includes('UTM_CREATIVE_PLACEHOLDER')) {
            // utm_creativeがない場合はプレースホルダーを空文字で置換
            processedBaseUrl = processedBaseUrl.replace('UTM_CREATIVE_PLACEHOLDER', '');
            console.log('⚠️ UTM_CREATIVEなし: プレースホルダーを空文字で置換');
        } else {
            console.log('❌ UTM_CREATIVE_PLACEHOLDER が見つかりません');
        }
        
        
        
        // パラメータを引き継いでリダイレクトURLを構築
        const redirectUrl = new URL(processedBaseUrl);
        
        // 現在のページURL（パラメータ付き）を取得
        let currentPageWithParams = window.location.href;
        
        // source_pageパラメータから元のページを取得して相対パス修正
        const sourcePage = urlParams.get('source_page');
        if (sourcePage && sourcePage.startsWith('/') && sourcePage !== '/' && !currentPageWithParams.includes(sourcePage.replace('/', ''))) {
            // source_pageが/medical-diet001/のような場合、リファラーも相対パスに修正
            const sourceDir = sourcePage.replace(/^\/|\/$/g, ''); // 前後のスラッシュを除去
            if (sourceDir && currentPageWithParams.includes('/go/dio/')) {
                currentPageWithParams = currentPageWithParams.replace('/go/dio/', `/${sourceDir}/go/dio/`);
                console.log('🔄 リファラーパス修正:', {
                    元のパス: window.location.href,
                    source_page: sourcePage,
                    修正後: currentPageWithParams
                });
            }
        }
        
        // 追跡用パラメータをparam4に統合
        // referrer_urlはパラメータを除いたベースURLのみを使用
        const baseReferrerUrl = currentPageWithParams.split('?')[0];
        const trackingParams = {
            click_section: urlParams.get('click_section') || '',
            click_clinic: urlParams.get('click_clinic') || '',
            source_page: urlParams.get('source_page') || '',
            region_id: urlParams.get('region_id') || '013',
            referrer_url: baseReferrerUrl,  // パラメータを除いたベースURLのみ
            timestamp: new Date().toISOString()
        };
        
        // param4として追跡データをエンコード
        redirectUrl.searchParams.set('param4', encodeURIComponent(JSON.stringify(trackingParams)));
        
        // 重要なパラメータは個別に引き継ぎ（アフィリエイト側で必須の場合）
        redirectUrl.searchParams.set('gclid', gclid || '');
        redirectUrl.searchParams.set('region_id', trackingParams.region_id);
        
        // UTMパラメータなどその他のパラメータも引き継ぎ
        const preserveParams = ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content', 'utm_creative'];
        preserveParams.forEach(param => {
            const value = urlParams.get(param);
            if (value) {
                redirectUrl.searchParams.set(param, value);
            }
        });
        
        const finalUrl = redirectUrl.toString();
        console.log('🔍 送信予定のリファラー:', currentPageWithParams);
        console.log('🎯 最終遷移先:', finalUrl);
        
        // param3の確認
        if (finalUrl.includes('param3=')) {
            const param3Match = finalUrl.match(/param3=([^&]*)/);
            if (param3Match && param3Match[1]) {
                console.log('✅ param3設定済み:', param3Match[1]);
            } else {
                console.log('⚠️ param3は存在するが値が空');
            }
        } else {
            console.log('❌ param3がURLに含まれていません');
        }
        
        // param2の確認
        if (finalUrl.includes('param2=')) {
            const param2Match = finalUrl.match(/param2=([^&]*)/);
            if (param2Match && param2Match[1]) {
                console.log('✅ param2設定済み:', param2Match[1]);
            } else {
                console.log('⚠️ param2は存在するが値が空');
            }
        } else {
            console.log('❌ param2がURLに含まれていません');
        }
        
        // param4の確認
        if (finalUrl.includes('param4=')) {
            const param4Match = finalUrl.match(/param4=([^&]*)/);
            if (param4Match && param4Match[1]) {
                try {
                    const decodedParam4 = JSON.parse(decodeURIComponent(param4Match[1]));
                    console.log('✅ param4設定済み:', decodedParam4);
                } catch (e) {
                    console.log('✅ param4設定済み (デコード不可):', param4Match[1]);
                }
            }
        }
        console.log('=============================================');
        
        // 手動リンクにもURLを設定
        document.getElementById('manualLink').href = finalUrl;
        
        // アナリティクスにクリックイベントを送信
        if (window.trackEvent) {
            trackEvent('clinic_redirect', {
                clinic_name: 'dio',
                destination_url: finalUrl,
                source_page: document.referrer || 'direct'
            });
        }
        
        // カウントダウン機能
        let countdown = 2;
        const countdownElement = document.getElementById('countdown');
        const manualLink = document.getElementById('manualLink');
        
        const timer = setInterval(() => {
            countdown--;
            if (countdown > 0) {
                countdownElement.textContent = `${countdown}秒後に移動します...`;
            } else {
                countdownElement.textContent = '移動中...';
                clearInterval(timer);
                
                // CATSにパラメータ付きリファラーを確実に送信
                setTimeout(() => {
                    console.log('📤 リダイレクト実行:', {
                        from: window.location.href,
                        to: finalUrl,
                        referrerPolicy: document.querySelector('meta[name="referrer"]')?.content
                    });
                    
                    // リダイレクトフラグを設定
                    let redirected = false;
                    
                    // 方法1: window.location.hrefでのリダイレクト
                    try {
                        window.location.href = finalUrl;
                        redirected = true;
                        console.log('✅ リダイレクト実行');
                    } catch (e) {
                        console.error('❌ リダイレクトエラー:', e);
                    }
                    
                    // フォールバック: 3秒後にまだページにいる場合のみ
                    setTimeout(() => {
                        if (!redirected && window.location.href.includes('/go/')) {
                            console.log('⚠️ フォールバックリダイレクト実行');
                            window.location.replace(finalUrl);
                        }
                    }, 3000)
                }, 500);
            }
        }, 1000);
        
        // 3秒後のリダイレクト後、さらに2秒経っても同じページにいる場合に警告表示
        setTimeout(() => {
            if (window.location.href.includes('/go/dio/')) {
                countdownElement.textContent = '自動移動に時間がかかっています。下のボタンをクリックしてください。';
                countdownElement.style.color = '#ff6b6b';
            }
        }, 5000);
    </script>
</body>
</html>