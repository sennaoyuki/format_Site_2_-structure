<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å…¬å¼ã‚µã‚¤ãƒˆã¸ç§»å‹•ä¸­...</title>
    <meta name="description" content="å…¬å¼ã‚µã‚¤ãƒˆã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¦ã„ã¾ã™ã€‚">
    <meta name="referrer" content="unsafe-url">
    <link rel="icon" type="image/png" href="/images/favicon.png">
    <meta http-equiv="Content-Security-Policy" content="referrer unsafe-url">
    <style>
        body {
            font-family: 'Noto Sans JP', sans-serif;
            background: linear-gradient(135deg, #f5f7fa 0%, #e9f2f9 100%);
            min-height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0;
            color: #333;
        }
        .redirect-container {
            text-align: center;
            padding: 40px;
            max-width: 500px;
            background: white;
            border-radius: 20px;
            box-shadow: 0 10px 40px rgba(0, 0, 0, 0.1);
        }
        .clinic-logo {
            width: 200px;
            height: auto;
            margin-bottom: 20px;
        }
        .redirect-message {
            font-size: 18px;
            font-weight: 600;
            margin-bottom: 15px;
            color: #4bc0c0;
        }
        .redirect-description {
            font-size: 14px;
            color: #666;
            margin-bottom: 30px;
            line-height: 1.6;
        }
        .loading-animation {
            display: inline-block;
            width: 40px;
            height: 40px;
            border: 3px solid #f3f3f3;
            border-top: 3px solid #4bc0c0;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        .manual-link {
            display: inline-block;
            margin-top: 20px;
            padding: 12px 24px;
            background: #4bc0c0;
            color: white;
            text-decoration: none;
            border-radius: 25px;
            font-weight: 600;
            transition: background 0.3s ease;
        }
        .manual-link:hover {
            background: #3da9a9;
        }
        .countdown {
            font-size: 16px;
            color: #666;
            margin-top: 10px;
        }
    </style>
</head>
<body>
    <div class="redirect-container">
        <img id="clinic-logo" class="clinic-logo" src="" alt="" style="display:none;">
        <div class="loading-animation"></div>
        <h1 id="redirect-message" class="redirect-message">å…¬å¼ã‚µã‚¤ãƒˆã¸ç§»å‹•ä¸­...</h1>
        <p id="redirect-description" class="redirect-description">
            ã¾ã‚‚ãªãè‡ªå‹•çš„ã«å…¬å¼ã‚µã‚¤ãƒˆã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚<br>
            ç§»å‹•ã—ãªã„å ´åˆã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚
        </p>
        <div class="countdown" id="countdown">2ç§’å¾Œã«ç§»å‹•ã—ã¾ã™...</div>
        <a href="#" id="manual-link" class="manual-link" style="display:none;">å…¬å¼ã‚µã‚¤ãƒˆã¸</a>
    </div>

    <script>
        // DataManager ã®ãƒ­ãƒ¼ãƒ‰
        function loadScript(src) {
            return new Promise((resolve, reject) => {
                const script = document.createElement('script');
                script.src = src;
                script.onload = resolve;
                script.onerror = reject;
                document.head.appendChild(script);
            });
        }

        // ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã¨configèª­ã¿è¾¼ã¿
        async function initializeDataManager() {
            try {
                // config.jsã‚’èª­ã¿è¾¼ã¿
                await loadScript('./config.js');
                
                // DataManagerã‚¯ãƒ©ã‚¹ã‚’ä½œæˆï¼ˆapp.jsã®ä¸€éƒ¨ã‚’æŠ½å‡ºï¼‰
                class SimpleDataManager {
                    constructor() {
                        this.clinicTexts = {};
                        this.clinics = [];
                    }
                    
                    async loadClinicTexts() {
                        const response = await fetch('./data/clinic-texts.json');
                        this.clinicTexts = await response.json();
                    }
                    
                    async loadCompiledData() {
                        console.log('ğŸ“Š compiled-data.jsonèª­ã¿è¾¼ã¿ä¸­...');
                        const response = await fetch('./data/compiled-data.json');
                        const data = await response.json();
                        this.clinics = data.clinics || [];
                        console.log('ğŸ“Š ã‚¯ãƒªãƒ‹ãƒƒã‚¯æ•°:', this.clinics.length);
                        console.log('ğŸ“Š èª­ã¿è¾¼ã¾ã‚ŒãŸã‚¯ãƒªãƒ‹ãƒƒã‚¯:', this.clinics.map(c => `${c.id}:${c.name}`));
                    }
                    
                    getClinicText(clinicCode, fieldName, defaultValue = '') {
                        // clinic-texts.jsonã®æ§‹é€ : { "ã‚¯ãƒªãƒ‹ãƒƒã‚¯å": { "ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å": "å€¤" } }
                        const clinicName = this.getClinicNameByCode(clinicCode);
                        if (!clinicName || !this.clinicTexts[clinicName]) {
                            console.log(`âš ï¸  ã‚¯ãƒªãƒ‹ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: code=${clinicCode}, name=${clinicName}`);
                            return defaultValue;
                        }
                        
                        const value = this.clinicTexts[clinicName][fieldName];
                        if (!value) {
                            console.log(`âš ï¸  ãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“: ${clinicName}.${fieldName}`);
                            return defaultValue;
                        }
                        
                        return value;
                    }
                    
                    getClinicNameByCode(clinicCode) {
                        // ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã‚³ãƒ¼ãƒ‰ã‹ã‚‰ã‚¯ãƒªãƒ‹ãƒƒã‚¯åã‚’å–å¾—
                        for (const clinicName in this.clinicTexts) {
                            if (this.clinicTexts[clinicName]['ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã‚³ãƒ¼ãƒ‰'] === clinicCode) {
                                return clinicName;
                            }
                        }
                        return null;
                    }
                    
                    getClinicById(clinicId) {
                        return this.clinics.find(clinic => clinic.id == clinicId);
                    }
                    
                    getClinicCodeById(clinicId) {
                        const clinic = this.getClinicById(clinicId);
                        return clinic ? clinic.code : null;
                    }
                }
                
                // ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–
                window.dataManager = new SimpleDataManager();
                await window.dataManager.loadClinicTexts();
                await window.dataManager.loadCompiledData();
                
                return true;
            } catch (error) {
                console.error('DataManager initialization failed:', error);
                return false;
            }
        }

        // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†
        async function handleRedirect() {
            console.log('ğŸš€ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†é–‹å§‹');
            
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å–å¾—
            const urlParams = new URLSearchParams(window.location.search);
            const clinicId = urlParams.get('clinic_id');
            const rank = parseInt(urlParams.get('rank')) || 1;
            
            console.log('ğŸ“‹ å—ã‘å–ã£ãŸãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿:');
            console.log(`  clinic_id: ${clinicId}`);
            console.log(`  rank: ${rank}`);
            console.log(`  ç¾åœ¨ã®URL: ${window.location.href}`);
            
            if (!clinicId) {
                console.error('âŒ clinic_idãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                window.location.href = './index.html';
                return;
            }
            
            console.log('ğŸ”„ ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–ä¸­...');
            // ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã‚’åˆæœŸåŒ–
            const initialized = await initializeDataManager();
            if (!initialized) {
                console.error('âŒ ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼ã®åˆæœŸåŒ–ã«å¤±æ•—');
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼šãƒ¡ã‚¤ãƒ³ãƒšãƒ¼ã‚¸ã«æˆ»ã‚‹
                window.location.href = './index.html';
                return;
            }
            console.log('âœ… ãƒ‡ãƒ¼ã‚¿ãƒãƒãƒ¼ã‚¸ãƒ£ãƒ¼åˆæœŸåŒ–å®Œäº†');
            
            // ã‚¯ãƒªãƒ‹ãƒƒã‚¯æƒ…å ±ã‚’å–å¾—
            const clinic = window.dataManager.getClinicById(clinicId);
            const clinicCode = window.dataManager.getClinicCodeById(clinicId);
            
            console.log('ğŸ¥ ã‚¯ãƒªãƒ‹ãƒƒã‚¯æƒ…å ±:');
            console.log(`  clinic: ${clinic ? clinic.name : 'not found'}`);
            console.log(`  clinicCode: ${clinicCode || 'not found'}`);
            
            if (!clinic || !clinicCode) {
                console.error('âŒ ã‚¯ãƒªãƒ‹ãƒƒã‚¯æƒ…å ±ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                window.location.href = './index.html';
                return;
            }
            
            // é·ç§»å…ˆURLã‚’å–å¾—
            const urlFieldName = `é·ç§»å…ˆURLï¼ˆ${rank}ä½ï¼‰`;
            let targetUrl = window.dataManager.getClinicText(clinicCode, urlFieldName, '');
            
            console.log('ğŸ” URLå–å¾—æƒ…å ±:');
            console.log(`  ã‚¯ãƒªãƒ‹ãƒƒã‚¯ã‚³ãƒ¼ãƒ‰: ${clinicCode}`);
            console.log(`  ãƒ©ãƒ³ã‚­ãƒ³ã‚°é †ä½: ${rank}`);
            console.log(`  URLãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰å: ${urlFieldName}`);
            console.log(`  å–å¾—ã—ãŸURL: ${targetUrl}`);
            
            if (!targetUrl) {
                // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ï¼š1ä½ã®URLã‚’ä½¿ç”¨
                console.log('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯: 1ä½ã®URLã‚’ä½¿ç”¨');
                targetUrl = window.dataManager.getClinicText(clinicCode, 'é·ç§»å…ˆURLï¼ˆ1ä½ï¼‰', '');
                console.log(`  ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯URL: ${targetUrl}`);
            }
            
            if (!targetUrl) {
                console.error('âŒ URLãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“');
                console.error('âŒ åˆ©ç”¨å¯èƒ½ãªURLãƒ•ã‚£ãƒ¼ãƒ«ãƒ‰:', Object.keys(window.dataManager.clinicTexts));
                // æœ€å¾Œã®æ‰‹æ®µï¼šç›´æ¥URLã‚’ç¢ºèª
                const availableUrls = {};
                for (let i = 1; i <= 5; i++) {
                    const field = `é·ç§»å…ˆURLï¼ˆ${i}ä½ï¼‰`;
                    const url = window.dataManager.getClinicText(clinicCode, field, '');
                    if (url) availableUrls[field] = url;
                }
                console.log('âŒ åˆ©ç”¨å¯èƒ½ãªURL:', availableUrls);
                
                window.location.href = './index.html';
                return;
            }
            
            // URLãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’å‡¦ç†
            const url = new URL(targetUrl);
            
            // region_idã‚’å–å¾—
            const regionId = urlParams.get('region_id');
            
            // è¿½è·¡ç”¨ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’param4ã«çµ±åˆï¼ˆmedical-diet001ã¨åŒã˜å½¢å¼ï¼‰
            const currentPageWithParams = window.location.href;
            const baseReferrerUrl = currentPageWithParams.split('?')[0];
            const trackingParams = {
                click_section: urlParams.get('click_section') || '',
                click_clinic: urlParams.get('click_clinic') || clinicCode,
                source_page: urlParams.get('source_page') || 'injection-lipolysis001',
                region_id: regionId || '013',
                referrer_url: baseReferrerUrl,  // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’é™¤ã„ãŸãƒ™ãƒ¼ã‚¹URLã®ã¿
                timestamp: new Date().toISOString()
            };
            
            // å…¨ã‚¯ãƒªãƒ‹ãƒƒã‚¯ãƒ»å…¨ãƒ©ãƒ³ã‚­ãƒ³ã‚°ä½ã«å¯¾ã—ã¦å‹•çš„ã«ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¿½åŠ 
            // param2ã«utm_creativeã‚’è¨­å®š
            const utmCreative = urlParams.get('utm_creative') || '';
            if (utmCreative) {
                url.searchParams.set('param2', utmCreative);
            }
            
            // param3ã«gclidã‚’è¨­å®š
            const gclid = urlParams.get('gclid') || '';
            if (gclid) {
                url.searchParams.set('param3', gclid);
            }
            
            // param4ã¨ã—ã¦è¿½è·¡ãƒ‡ãƒ¼ã‚¿ã‚’ã‚¨ãƒ³ã‚³ãƒ¼ãƒ‰
            url.searchParams.set('param4', encodeURIComponent(JSON.stringify(trackingParams)));
            
            // region_idã‚’è¿½åŠ 
            if (regionId) {
                url.searchParams.set('region_id', regionId);
            }
            
            // ãã®ä»–ã®UTMãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚‚è»¢é€
            ['utm_source', 'utm_medium', 'utm_campaign', 'utm_term', 'utm_content'].forEach(param => {
                const value = urlParams.get(param);
                if (value) {
                    url.searchParams.set(param, value);
                }
            });
            
            const finalUrl = url.toString();
            
            // UIè¦ç´ ã‚’æ›´æ–°
            const clinicLogo = document.getElementById('clinic-logo');
            const redirectMessage = document.getElementById('redirect-message');
            const redirectDescription = document.getElementById('redirect-description');
            const manualLink = document.getElementById('manual-link');
            
            redirectMessage.textContent = `${clinic.name}å…¬å¼ã‚µã‚¤ãƒˆã¸ç§»å‹•ä¸­...`;
            redirectDescription.innerHTML = `ã¾ã‚‚ãªãè‡ªå‹•çš„ã«${clinic.name}ã®å…¬å¼ã‚µã‚¤ãƒˆã¸ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã—ã¾ã™ã€‚<br>ç§»å‹•ã—ãªã„å ´åˆã¯ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚`;
            manualLink.textContent = `${clinic.name}å…¬å¼ã‚µã‚¤ãƒˆã¸`;
            manualLink.href = finalUrl;
            manualLink.style.display = 'inline-block';
            
            // ãƒ­ã‚´ã®è¨­å®š
            const logoPath = `/images/clinics/${clinicCode}/${clinicCode}-logo.webp`;
            clinicLogo.src = logoPath;
            clinicLogo.alt = clinic.name;
            clinicLogo.style.display = 'block';
            
            // ãƒ­ã‚´ã®ã‚¨ãƒ©ãƒ¼å‡¦ç†
            clinicLogo.onerror = function() {
                const jpgPath = `/images/clinics/${clinicCode}/${clinicCode}-logo.jpg`;
                this.src = jpgPath;
                this.onerror = function() {
                    this.style.display = 'none';
                };
            };
            
            // ã‚¿ã‚¤ãƒˆãƒ«ã‚‚æ›´æ–°
            document.title = `${clinic.name}å…¬å¼ã‚µã‚¤ãƒˆã¸ç§»å‹•ä¸­...`;
            
            // ã‚«ã‚¦ãƒ³ãƒˆãƒ€ã‚¦ãƒ³é–‹å§‹ï¼ˆ2ç§’ï¼‰
            let countdown = 2;
            const countdownElement = document.getElementById('countdown');
            
            const timer = setInterval(() => {
                countdown--;
                if (countdown > 0) {
                    countdownElement.textContent = `${countdown}ç§’å¾Œã«ç§»å‹•ã—ã¾ã™...`;
                } else {
                    countdownElement.textContent = 'ç§»å‹•ä¸­...';
                    clearInterval(timer);
                    
                    // ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè¡Œ
                    setTimeout(() => {
                        console.log('ğŸ“¤ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè¡Œæº–å‚™å®Œäº†');
                        console.log(`  é·ç§»å…ƒ: ${window.location.href}`);
                        console.log(`  é·ç§»å…ˆ: ${finalUrl}`);
                        console.log(`  æœ€çµ‚URLæ¤œè¨¼: ${finalUrl.startsWith('http')}`);
                        
                        // param4ã®ç¢ºèª
                        if (finalUrl.includes('param4=')) {
                            const param4Match = finalUrl.match(/param4=([^&]*)/);
                            if (param4Match && param4Match[1]) {
                                try {
                                    const decodedParam4 = JSON.parse(decodeURIComponent(param4Match[1]));
                                    console.log('âœ… param4è¨­å®šæ¸ˆã¿:', decodedParam4);
                                } catch (e) {
                                    console.log('âœ… param4è¨­å®šæ¸ˆã¿ (ãƒ‡ã‚³ãƒ¼ãƒ‰ä¸å¯):', param4Match[1]);
                                }
                            } else {
                                console.log('âš ï¸ param4ã¯å­˜åœ¨ã™ã‚‹ãŒå€¤ãŒç©º');
                            }
                        } else {
                            console.log('âŒ param4ãŒURLã«å«ã¾ã‚Œã¦ã„ã¾ã›ã‚“');
                        }
                        
                        if (!finalUrl || finalUrl === '#' || !finalUrl.startsWith('http')) {
                            console.error('âŒ ç„¡åŠ¹ãªURL:', finalUrl);
                            return;
                        }
                        
                        try {
                            console.log('ğŸš€ window.location.hrefå®Ÿè¡Œä¸­...');
                            window.location.href = finalUrl;
                            console.log('âœ… ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‘½ä»¤å®Œäº†');
                        } catch (e) {
                            console.error('âŒ ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚¨ãƒ©ãƒ¼:', e);
                        }
                        
                        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
                        setTimeout(() => {
                            if (window.location.href.includes('/redirect.html')) {
                                console.log('âš ï¸ ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå®Ÿè¡Œ');
                                window.location.replace(finalUrl);
                            }
                        }, 3000);
                    }, 500);
                }
            }, 1000);
            
            // 5ç§’å¾Œã«ã¾ã åŒã˜ãƒšãƒ¼ã‚¸ã«ã„ã‚‹å ´åˆã®è­¦å‘Š
            setTimeout(() => {
                if (window.location.href.includes('/redirect.html')) {
                    countdownElement.textContent = 'è‡ªå‹•ç§»å‹•ã«æ™‚é–“ãŒã‹ã‹ã£ã¦ã„ã¾ã™ã€‚ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã—ã¦ãã ã•ã„ã€‚';
                    countdownElement.style.color = '#ff6b6b';
                }
            }, 5000);
            
            // æ‰‹å‹•ãƒªãƒ³ã‚¯ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆ
            manualLink.addEventListener('click', (e) => {
                e.preventDefault();
                clearInterval(timer);
                window.location.href = finalUrl;
            });
        }

        // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿å®Œäº†æ™‚ã«ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆå‡¦ç†ã‚’é–‹å§‹
        document.addEventListener('DOMContentLoaded', handleRedirect);
    </script>
</body>
</html>