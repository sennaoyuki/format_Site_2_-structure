<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>GCLID Debug Test</title>
    <style>
        body {
            font-family: Arial, sans-serif;
            max-width: 1200px;
            margin: 50px auto;
            padding: 20px;
            background: #f5f5f5;
        }
        .debug-section {
            background: white;
            padding: 20px;
            margin-bottom: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        .test-button {
            display: inline-block;
            padding: 15px 30px;
            background: #007bff;
            color: white;
            text-decoration: none;
            border-radius: 4px;
            margin: 10px 0;
            font-size: 18px;
            cursor: pointer;
            border: none;
        }
        .test-button:hover {
            background: #0056b3;
        }
        .log-output {
            background: #f8f9fa;
            padding: 15px;
            border-radius: 4px;
            font-family: monospace;
            font-size: 14px;
            margin-top: 10px;
            max-height: 400px;
            overflow-y: auto;
            white-space: pre-wrap;
        }
        .success {
            color: #28a745;
            font-weight: bold;
        }
        .error {
            color: #dc3545;
            font-weight: bold;
        }
        .info {
            color: #17a2b8;
        }
        iframe {
            width: 100%;
            height: 600px;
            border: 1px solid #ddd;
            border-radius: 4px;
        }
    </style>
</head>
<body>
    <h1>GCLIDç½®æ›å‡¦ç†ãƒ‡ãƒãƒƒã‚°ãƒ„ãƒ¼ãƒ«</h1>
    
    <div class="debug-section">
        <h2>1. ç¾åœ¨ã®URLæƒ…å ±</h2>
        <p><strong>ç¾åœ¨ã®URL:</strong> <span id="currentUrl"></span></p>
        <p><strong>GCLID:</strong> <span id="gclidValue" class="info"></span></p>
    </div>
    
    <div class="debug-section">
        <h2>2. ãƒ†ã‚¹ãƒˆãƒªãƒ³ã‚¯ï¼ˆæ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ãï¼‰</h2>
        <p>ä»¥ä¸‹ã®ãƒœã‚¿ãƒ³ã‚’ã‚¯ãƒªãƒƒã‚¯ã™ã‚‹ã¨ã€æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒšãƒ¼ã‚¸ã‚’é–‹ãã€å‡¦ç†ã‚’ç¢ºèªã§ãã¾ã™ï¼š</p>
        
        <button class="test-button" onclick="testGclidReplacement()">
            GCLIDç½®æ›ãƒ†ã‚¹ãƒˆã‚’å®Ÿè¡Œ
        </button>
        
        <div id="testResult" class="log-output" style="display:none;"></div>
    </div>
    
    <div class="debug-section">
        <h2>3. iframeå†…ã§ã®ãƒ†ã‚¹ãƒˆï¼ˆãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’é˜²ãï¼‰</h2>
        <p>ä»¥ä¸‹ã®iframeå†…ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒšãƒ¼ã‚¸ã‚’èª­ã¿è¾¼ã¿ã€å‡¦ç†ã‚’ç¢ºèªã—ã¾ã™ï¼š</p>
        
        <button class="test-button" onclick="loadInIframe()">
            iframeã§ãƒ†ã‚¹ãƒˆ
        </button>
        
        <iframe id="testFrame" style="display:none;"></iframe>
        <div id="iframeLog" class="log-output" style="display:none;"></div>
    </div>
    
    <div class="debug-section">
        <h2>4. ãƒ†ã‚¹ãƒˆç”¨GCLIDä»˜ããƒªãƒ³ã‚¯</h2>
        <a href="?gclid=DEBUG_TEST_12345" class="test-button">GCLID: DEBUG_TEST_12345</a>
        <a href="?gclid=SAMPLE_XYZ_789" class="test-button">GCLID: SAMPLE_XYZ_789</a>
        <a href="?" class="test-button">GCLIDãªã—ï¼ˆãƒªã‚»ãƒƒãƒˆï¼‰</a>
    </div>

    <script>
        // ç¾åœ¨ã®URLæƒ…å ±ã‚’è¡¨ç¤º
        document.getElementById('currentUrl').textContent = window.location.href;
        
        // GCLIDã‚’å–å¾—ã—ã¦è¡¨ç¤º
        const urlParams = new URLSearchParams(window.location.search);
        const gclid = urlParams.get('gclid');
        const gclidElement = document.getElementById('gclidValue');
        
        if (gclid) {
            gclidElement.textContent = gclid;
            gclidElement.classList.add('success');
        } else {
            gclidElement.textContent = 'ãªã—ï¼ˆãƒ†ã‚¹ãƒˆç”¨GCLIDã‚’è¨­å®šã—ã¦ãã ã•ã„ï¼‰';
            gclidElement.classList.add('error');
        }
        
        // GCLIDç½®æ›ãƒ†ã‚¹ãƒˆ
        function testGclidReplacement() {
            const testGclid = gclid || 'TEST_' + Date.now();
            const testUrl = `/medical-diet001/go/dio/?gclid=${testGclid}&debug=true`;
            
            const resultDiv = document.getElementById('testResult');
            resultDiv.style.display = 'block';
            resultDiv.innerHTML = `ãƒ†ã‚¹ãƒˆé–‹å§‹...\n`;
            resultDiv.innerHTML += `ãƒ†ã‚¹ãƒˆGCLID: ${testGclid}\n`;
            resultDiv.innerHTML += `ãƒ†ã‚¹ãƒˆURL: ${testUrl}\n\n`;
            
            // æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§é–‹ã
            const newWindow = window.open(testUrl, '_blank', 'width=800,height=600');
            
            // å‡¦ç†çµæœã‚’è¡¨ç¤º
            setTimeout(() => {
                resultDiv.innerHTML += `\nå‡¦ç†å†…å®¹:\n`;
                resultDiv.innerHTML += `1. URLã«å«ã¾ã‚Œã‚‹ [GCLID_PLACEHOLDER] ã‚’æ¤œç´¢\n`;
                resultDiv.innerHTML += `2. gclidãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼ˆ${testGclid}ï¼‰ã§ç½®æ›\n`;
                resultDiv.innerHTML += `3. æœ€çµ‚URL: https://sss.ac01.l-ad.net/...&param3=${testGclid}\n`;
                resultDiv.innerHTML += `\nâœ… æ–°ã—ã„ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ã§ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆãƒšãƒ¼ã‚¸ãŒé–‹ãã¾ã—ãŸ\n`;
                resultDiv.innerHTML += `é–‹ç™ºè€…ãƒ„ãƒ¼ãƒ«ã®ã‚³ãƒ³ã‚½ãƒ¼ãƒ«ã§è©³ç´°ã‚’ç¢ºèªã—ã¦ãã ã•ã„`;
            }, 1000);
        }
        
        // iframeã§ã®ãƒ†ã‚¹ãƒˆ
        function loadInIframe() {
            const testGclid = gclid || 'IFRAME_TEST_' + Date.now();
            const testUrl = `/medical-diet001/go/dio/index.html?gclid=${testGclid}&debug=true`;
            
            const iframe = document.getElementById('testFrame');
            const logDiv = document.getElementById('iframeLog');
            
            iframe.style.display = 'block';
            logDiv.style.display = 'block';
            logDiv.innerHTML = `iframeå†…ã§ãƒ†ã‚¹ãƒˆä¸­...\n`;
            logDiv.innerHTML += `ãƒ†ã‚¹ãƒˆGCLID: ${testGclid}\n`;
            logDiv.innerHTML += `èª­ã¿è¾¼ã¿URL: ${testUrl}\n\n`;
            
            // ã‚µãƒ³ãƒ‰ãƒœãƒƒã‚¯ã‚¹ã‚’è¨­å®šã—ã¦ãƒªãƒ€ã‚¤ãƒ¬ã‚¯ãƒˆã‚’é˜²ã
            iframe.setAttribute('sandbox', 'allow-scripts allow-same-origin');
            
            iframe.onload = function() {
                try {
                    const iframeDoc = iframe.contentDocument || iframe.contentWindow.document;
                    const scripts = iframeDoc.getElementsByTagName('script');
                    
                    logDiv.innerHTML += `\nâœ… ãƒšãƒ¼ã‚¸ãŒèª­ã¿è¾¼ã¾ã‚Œã¾ã—ãŸ\n`;
                    logDiv.innerHTML += `ã‚¹ã‚¯ãƒªãƒ—ãƒˆæ•°: ${scripts.length}\n`;
                    
                    // ã‚¹ã‚¯ãƒªãƒ—ãƒˆå†…å®¹ã‚’ç¢ºèª
                    for (let i = 0; i < scripts.length; i++) {
                        if (scripts[i].innerHTML.includes('GCLID_PLACEHOLDER')) {
                            logDiv.innerHTML += `\nğŸ” GCLID_PLACEHOLDERå‡¦ç†ã‚’æ¤œå‡ºã—ã¾ã—ãŸï¼\n`;
                            
                            // å‡¦ç†å†…å®¹ã‚’æŠ½å‡º
                            const scriptContent = scripts[i].innerHTML;
                            if (scriptContent.includes('processedBaseUrl.replace')) {
                                logDiv.innerHTML += `âœ… ç½®æ›å‡¦ç†ãŒå®Ÿè£…ã•ã‚Œã¦ã„ã¾ã™\n`;
                                logDiv.innerHTML += `æœŸå¾…ã•ã‚Œã‚‹çµæœ: param3=${testGclid}\n`;
                            }
                        }
                    }
                } catch (e) {
                    logDiv.innerHTML += `\nâš ï¸ iframeå†…å®¹ã®èª­ã¿å–ã‚Šã«å¤±æ•—ï¼ˆã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£åˆ¶é™ï¼‰\n`;
                    logDiv.innerHTML += `ã“ã‚Œã¯æ­£å¸¸ãªå‹•ä½œã§ã™ã€‚å®Ÿéš›ã®ãƒšãƒ¼ã‚¸ã§ã¯æ­£ã—ãå‹•ä½œã—ã¾ã™ã€‚\n`;
                }
            };
            
            iframe.src = testUrl;
        }
    </script>
</body>
</html>